<!doctype html>
<html>

<head>
    <!-- <link rel="stylesheet" href="node_modules/@xterm/xterm/css/xterm.css" /> -->
    <!-- <link rel="stylesheet" href="node_modules/xterm.css" /> -->
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js"></script>
    <!-- <script src="node_modules/@xterm/addon-webgl/lib/addon-webgl.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-webgl@0.16.0/lib/xterm-addon-webgl.min.js"></script>
    <!-- <script src="node_modules/@xterm/addon-fit/lib/addon-fit.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-image@0.5.0/lib/xterm-addon-image.min.js"></script>
    <!-- <script src="node_modules/@xterm/xterm/lib/xterm.js"></script> -->
</head>

<body>
    <style>
        .top-div {
            position: absolute;
            top: 50px;
            left: 100px;
            width: 600px;
            height: 400px;
            padding: 20px;
            border: 2px;
            border-color: aquamarine;
            z-index: 2;
        }
    </style>
    <div id="open" style="display: none;"></div>
    <div id="terminal"></div>
    <script>
        function appendToTerminal(message) {
            const terminal = document.getElementById('terminal');
            terminal.innerHTML += message + '<br>';
            terminal.scrollTop = terminal.scrollHeight; // 自动滚动到底部
        }
        let rows = 50
        let cols = 80
        document.onkeydown = function (e) {
            e = e || window.event;//Get event

            if (!e.ctrlKey) return;

            var code = e.which || e.keyCode;//Get key code
            e.preventDefault();
            e.stopPropagation();
        };

        var term = new Terminal({
            cursorStyle: 'bar',  // 默认为块状光标
            allowTransparency: true,
            cursorBlink: false,
            cursorWidth: 4,
            rows: rows,
            cols: cols,
            vt200Mouse: true,
            x10Mouse: true,
            vt300Mouse: true,
            MouseEvent: true,
            // minimumContrastRatio: 1,
        });
        window.addEventListener("contextmenu", function (e) {
            e.preventDefault();
        })
        var socket = new WebSocket('ws://localhost:13000/ws');
        function sendTextData(data) {
            if (socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify(data));
                console.log('Sent to server:', data);
            } else {
                console.error('WebSocket connection is not open.');
            }
        }
        const resizecall = () => {
            let call = "resize"
            let rows = term.rows, cols = term.cols
            sendTextData({ call, cols, rows })
        }
        socket.onopen = function (event) {
            console.log("Connection opened");
            call = "init"
            sendTextData({ call })

        };



        function getFileExtension(filename) {
            const lastDotIndex = filename.lastIndexOf('.');
            if (lastDotIndex === -1) {
                return ''; // 没有扩展名
            }
            return filename.substring(lastDotIndex + 1);
        }

        function is_image(ext) {
            return ["jpg", "png", "gif", "jpeg", "bmp"].includes(ext)
        }

        socket.onmessage = function (event) {
            var data = JSON.parse(event.data);
            var { call, output } = data
            if (call == "term") {
                term.write(output)
            }
            else if (call == "openfile") {
                console.log("openfile",
                    data.Filename)
                let ext = getFileExtension(data.Filename)
                if (is_image(ext)) {

                    document.getElementById("open").innerHTML = "<img src=\"" + data.Filename + "\"/>"
                    document.getElementById("open").style.display = "block"
                    document.getElementById("open").className = "top-div"
                    document.getElementById("open").addEventListener("click", function () {
                        document.getElementById("open").style.display = "none"
                    })
                }
            }
            console.log("Received: ", event.data);
        };
        socket.onclose = function (event) {
            console.log("Connection closed");
        };
        var wl = new WebglAddon.WebglAddon()
        term.loadAddon(wl)
        var fit = new FitAddon.FitAddon()
        term.loadAddon(fit);

        // const imageAddon = new ImageAddon.ImageAddon(customSettings);
        // terminal.loadAddon(imageAddon);
        term.onData(function (data) {
            let call = "key"
            let rows = term.rows, cols = term.cols

            sendTextData({ call, data, rows, cols })
            console.log(data)
        })
        term.onResize((size) => {
            resizecall()
        })
        old = ""
        term.open(document.getElementById('terminal'));
        fit.fit()
    </script>
</body>

</html>