<!doctype html>
<html>

<head>
    <!-- <link rel="stylesheet" href="node_modules/@xterm/xterm/css/xterm.css" /> -->
    <!-- <link rel="stylesheet" href="node_modules/xterm.css" /> -->
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js"></script>
    <script src="node_modules/@xterm/addon-webgl/lib/addon-webgl.js"></script>
    <script src="node_modules/@xterm/addon-fit/lib/addon-fit.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-image@0.5.0/lib/xterm-addon-image.min.js"></script>
    <!-- <script src="node_modules/@xterm/xterm/lib/xterm.js"></script> -->
</head>

<body>
    <div id="terminal"></div>
    <script>
        let rows = 50
        let cols = 80
        document.onkeydown = function (e) {
            e = e || window.event;//Get event

            if (!e.ctrlKey) return;

            var code = e.which || e.keyCode;//Get key code
            e.preventDefault();
            e.stopPropagation();
        };

        var term = new Terminal({
            cursorStyle: 'bar',  // 默认为块状光标
            allowTransparency: true,
            cursorBlink: false,
            cursorWidth: 4,
            rows: rows,
            cols: cols,
            vt200Mouse: true,
            x10Mouse: true,
            vt300Mouse: true,
            MouseEvent: true,
            // minimumContrastRatio: 1,
        });
        window.addEventListener("contextmenu", function (e) {
            e.preventDefault();
        })
        var socket = new WebSocket('ws://localhost:13000/ws');
        function sendTextData(data) {
            if (socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify(data));
                console.log('Sent to server:', data);
            } else {
                console.error('WebSocket connection is not open.');
            }
        }

        socket.onopen = function (event) {
            console.log("Connection opened");
            call = "init"
            sendTextData({ call })
            call = "resize"
            let rows = term.rows, cols = term.cols
            sendTextData({ call, cols, rows })
        };
        socket.onmessage = function (event) {
            var data = JSON.parse(event.data);
            var { type, output } = data
            if (type == "term") {
                term.write(output)
            }
            console.log("Received: ", event.data);
        };
        socket.onclose = function (event) {
            console.log("Connection closed");
        };
        var wl = new WebglAddon.WebglAddon()
        term.loadAddon(wl)
        var fit = new FitAddon.FitAddon()
        term.loadAddon(fit);

        // const imageAddon = new ImageAddon.ImageAddon(customSettings);
        // terminal.loadAddon(imageAddon);
        term.onData(function (data) {
            let call = "key"
            let rows = term.rows, cols = term.cols
            sendTextData({ call, data })
            console.log(data)
        })
        term.onResize((size) => {
            let call = "resize"
            resize = size
            sendTextData({ call, resize })
        })
        // term.onKey(function (a) {
        //     console.log(a)
        //     axios.post('/key', {
        //         key: a.key
        //     }).then(function (response) {

        //     })
        // })
        old = ""
        term.open(document.getElementById('terminal'));
        // term.write('Hello from \x1B[1;3;31mxterm.js\x1B[0m $ ')
        // const get_term = function () {
        //     axios.post('/term', {
        //         width: term.cols,
        //         height: term.rows,
        //     }).then(function (response) {
        //         if (response.data != "0000") {
        //             term.write(response.data);
        //         }
        //         get_term();
        //     })
        // };
        // get_term();

        fit.fit()
    </script>
</body>

</html>